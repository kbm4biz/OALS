<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø±Ø´Ø§Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>

  <style>
    :root{
      --bg-1:#f6f9ff;
      --bg-2:#f2fbf6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border: rgba(15, 23, 42, .08);

      --primary:#2563eb;   /* Ø£Ø²Ø±Ù‚ */
      --primary-2:#06b6d4; /* Ø³Ù…Ø§ÙˆÙŠ */
      --success:#16a34a;
      --warning:#f59e0b;
      --danger:#ef4444;

      --shadow: 0 18px 45px rgba(15,23,42,.10);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 15% 5%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(700px 450px at 85% 10%, rgba(6,182,212,.10), transparent 55%),
        linear-gradient(120deg, var(--bg-1), var(--bg-2));
      color: var(--text);
      min-height: 100vh;
      padding: 78px 14px 100px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ù†Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
      direction: rtl;
    }

    /* ===== News banner ===== */
    .news-banner{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:#fff;
      padding: 12px 0;
      text-align:center;
      font-weight:800;
      overflow:hidden;
      white-space:nowrap;
      position:fixed;
      top:0; left:0;
      width:100%;
      z-index: 50;
      box-shadow: 0 8px 22px rgba(0,0,0,.15);
    }
    .news-banner p{
      display:inline-block;
      padding-left: 100%;
      animation: scrollLeft 18s linear infinite;
      margin:0;
      letter-spacing:.2px;
    }
    @keyframes scrollLeft{
      0%{ transform: translateX(100%); }
      100%{ transform: translateX(-100%); }
    }

    /* ===== Background floating emojis/logo ===== */
    .emoji-background{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 1;
      overflow:hidden;
    }
    .emoji-scroll{
      position:absolute;
      animation: scrollUp 20s linear infinite;
      opacity:.14;
      font-size:1.65rem;
      user-select:none;
      filter: saturate(1.1);
    }
    .emoji-scroll img{
      display:inline-block;
      vertical-align: middle;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.10));
    }
    @keyframes scrollUp{
      from{ transform: translateY(110vh); }
      to{ transform: translateY(-120px); }
    }

    /* ===== Layout container ===== */
    .wrap{
      position: relative;
      z-index: 5;
      max-width: 760px;
      margin: 0 auto;
    }

    /* ===== Header ===== */
    .hero{
      border-radius: var(--radius);
      background: linear-gradient(135deg,
        rgba(37,99,235,.95),
        rgba(6,182,212,.90));
      color: #fff;
      padding: 20px 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.20);
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-80px -120px auto auto;
      width: 260px;
      height: 260px;
      background: rgba(255,255,255,.18);
      border-radius: 50%;
      filter: blur(0px);
      transform: rotate(20deg);
    }
    .hero-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .brand-badge{
      width: 46px; height: 46px;
      border-radius: 14px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(6px);
      overflow:hidden;
    }
    .brand-badge img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .brand-title{
      font-weight: 900;
      font-size: 1.35rem;
      line-height: 1.1;
      margin: 0;
    }
    .brand-sub{
      margin: 2px 0 0;
      opacity: .92;
      font-weight: 600;
      font-size: .95rem;
    }

    .hero-meta{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      backdrop-filter: blur(6px);
      font-weight: 800;
      font-size: .92rem;
      white-space: nowrap;
    }
    .pill small{
      font-weight: 700;
      opacity: .92;
    }

    /* ===== Main Card ===== */
    .card{
      margin-top: 14px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }
    .card h1{
      margin: 2px 0 8px;
      font-size: 1.25rem;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .note{
      color: rgba(255,255,255,.95);
      margin-top: 12px;
      line-height: 1.6;
      font-weight: 650;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      padding: 10px 12px;
      border-radius: 14px;
      backdrop-filter: blur(6px);
    }
    .helper{
      color: var(--muted);
      margin: 6px 0 0;
      line-height: 1.6;
      font-weight: 650;
      font-size: .95rem;
    }

    /* ===== Form ===== */
    form{margin-top: 14px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
    }

    .field{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
    }
    .field label{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 900;
      margin-bottom: 8px;
      font-size: 0.98rem;
    }
    .field label span{
      color: var(--muted);
      font-weight: 800;
      font-size: .88rem;
    }

    .input-wrap{
      position: relative;
    }
    input{
      width: 100%;
      border-radius: 14px;
      padding: 14px 14px 14px 46px;
      border: 1px solid rgba(15,23,42,.12);
      outline: none;
      font-size: 1.05rem;
      font-weight: 800;
      letter-spacing: .6px;
      transition: .18s;
      background: #fff;
      text-align: right;
    }
    input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 5px rgba(37,99,235,.12);
    }
    .clear-btn{
      position:absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(15,23,42,.06);
      color: rgba(15,23,42,.75);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      transition: .15s;
    }
    .clear-btn:hover{
      background: rgba(15,23,42,.10);
    }

    .field-error{
      display:none;
      margin-top: 8px;
      color: var(--danger);
      font-weight: 900;
      font-size: .92rem;
    }

    /* ===== CTA button ===== */
    .cta{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .btn{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      border:none;
      cursor:pointer;
      padding: 14px 16px;
      border-radius: 18px;
      font-size: 1.05rem;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 14px 28px rgba(37,99,235,.22);
      transition: transform .06s, filter .2s, opacity .2s;
    }
    .btn:active{ transform: scale(.99); }
    .btn:disabled{ opacity: .65; cursor:not-allowed; box-shadow:none; }

    /* logo spinner inside button */
    .btn-loader{
      width: 26px;
      height: 26px;
      border-radius: 50%;
      overflow:hidden;
      display:none;
      animation: spin 1.1s linear infinite;
      border: 2px solid rgba(255,255,255,.35);
      flex: 0 0 auto;
    }
    .btn-loader img{ width:100%; height:100%; object-fit: cover; display:block; }
    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* ===== Response ===== */
    .response{
      margin-top: 14px;
      display:none;
    }
    .status{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      line-height: 1.7;
      font-weight: 800;
      color: var(--text);
    }
    .status.success{ background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.22); }
    .status.warning{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
    .status.error{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); }

    .result{
      margin-top: 10px;
    }
    .result .box{
      border-radius: 18px;
      padding: 14px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: 0 10px 26px rgba(15,23,42,.06);
      text-align:center;
    }
    .result a{
      display:inline-block;
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      text-decoration:none;
      font-weight: 950;
      color: #0b1220;
      background: rgba(6,182,212,.16);
      border: 1px solid rgba(6,182,212,.25);
      transition: .15s;
    }
    .result a:hover{ filter: brightness(.98); }
    .qr{
      margin-top: 10px;
      display:flex;
      justify-content:center;
    }
    .qr img{
      width: 170px;
      height: 170px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background:#fff;
      padding: 8px;
    }

    /* ===== Steps (keep gear spin) ===== */
    .scrolling-gear{
      display:inline-block;
      animation: spin 10s linear infinite;
      margin-right: 8px;
    }

    /* ===== Maintenance message ===== */
    #formDisabledMessage{
      display:none;
      text-align:center;
      padding: 14px;
      border-radius: 18px;
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.22);
      color: var(--danger);
      font-weight: 950;
      margin-top: 12px;
    }

    /* ===== Footer ===== */
    .footer{
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 40;
      background: rgba(255,255,255,.92);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(10px);
      padding: 12px 14px;
    }
    .footer .inner{
      max-width: 760px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-weight: 900;
      color: rgba(15,23,42,.70);
    }
  </style>

  <script>
    // =====================
    // FLAGS
    // =====================
    const ENABLE_FORM = true;
    const ENABLE_BANNER = true;
    const NEWS_BANNER_TEXT = " ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ 14-01-2026 14:290";

    const AUTO_SUBMIT_ON_PREFILL = true;
    const PREFILL_KEYS = ["studentId", "id"];

    // âœ… Ø¬Ø¯ÙŠØ¯: ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹
    const ENABLE_GPS_VERIFY = false; // true = Ù…ÙØ¹Ù„ | false = ØºÙŠØ± Ù…ÙØ¹Ù„

    // âœ… Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Apps Script Web App (/exec)
    const VALIDATION_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbypVeYVhvsi_O91QbTB782mGfrbyvi_8qoF6B94H3nxZVtBtkBcflfbPr6KSFwk640tBg/exec";

    // Power Automate Flow endpoint (ÙƒÙ…Ø§ Ù‡Ùˆ)
    const FLOW_ENDPOINT = 'https://defaultde8d64b779da419880c27b84343483.4f.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4255a7e944c347adac8f2230e02bc510/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aeXEH2HrjtWGyc_hNgpP-iyFz3nrh4GiSVz2W0qmf6Y';

    // Polling backoff
    const POLL_BASE = 2000;
    const POLL_MAX  = 9000;

    // GPS location list (CSV) ÙƒÙ…Ø§ Ù‡Ùˆ
    const LOCATION_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2cFw2_Jrr1j-Iy48e2BREiBlJ9Bj5vMTh3tl72YtTcnJ2DOXUDrD9I5SeVH0WSHeg9ec_tzXDZgEN/pub?output=csv';
    const RADIUS_KM = 0.2; //0.2;

    let locationData = null;

    // normalize Arabic digits
    function normalizeDigits(s) {
      const map = {
        'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9',
        'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'
      };
      return String(s).replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] ?? d);
    }

    document.addEventListener("DOMContentLoaded", async function() {
      // banner
      const banner = document.getElementById('newsBanner');
      if (!ENABLE_BANNER) banner.style.display = "none";
      else {
        banner.style.display = "block";
        banner.querySelector('p').textContent = NEWS_BANNER_TEXT;
      }

      // maintenance
      if (!ENABLE_FORM) {
        document.getElementById('reportForm').style.display = "none";
        document.getElementById('formDisabledMessage').style.display = "block";
      }

      // GPS pill text (new)
      const gpsPill = document.getElementById('gpsPillText');
      if (gpsPill) gpsPill.textContent = ENABLE_GPS_VERIFY ? 'ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ¹Ù„' : 'ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù„';

      // preload location data (only if GPS enabled)
      if (ENABLE_GPS_VERIFY) {
        try {
          const response = await fetch(LOCATION_SHEET_URL);
          if (!response.ok) throw new Error('Network response for location data was not ok');
          const csvText = await response.text();
          locationData = processLocationCSV(csvText);
        } catch (error) {
          console.error('Failed to load location data:', error);
          if (ENABLE_FORM) {
            document.getElementById('submitBtn').disabled = true;
            showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø£Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ¹Ù„.');
          }
        }
      } else {
        // GPS disabled: do not load locations and do not block the form
        locationData = null;
      }

      // prefill
      try {
        const params = new URLSearchParams(location.search);
        const noSubmit = params.has('nosubmit');

        const raw =
          PREFILL_KEYS.map(k => params.get(k))
                      .find(v => v && v.trim().length > 0) || "";

        if (raw) {
          const input = document.getElementById('studentId');
          input.value = normalizeDigits(raw).replace(/\D+/g, "").slice(0, 9);

          if (
            input.value &&
            AUTO_SUBMIT_ON_PREFILL &&
            !noSubmit &&
            ENABLE_FORM &&
            !document.getElementById('submitBtn').disabled
          ) {
            setTimeout(() => {
              const formEl = document.getElementById('reportForm');
              if (formEl.requestSubmit) formEl.requestSubmit();
              else formEl.querySelector('button[type="submit"]').click();
            }, 0);
          }
        }
      } catch (e) {
        console.warn("Prefill error:", e);
      }

      // âœ… NEW: load total downloads at startup
      fetchTotalDownloads();
    });

    // ===== JSONP helper (CORS-safe) =====
    function jsonp(url, timeoutMs = 8000){
      return new Promise((resolve, reject) => {
        const cb = `cb_${Date.now()}_${Math.floor(Math.random()*100000)}`;
        const script = document.createElement('script');

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ (timeout).'));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          delete window[cb];
          script.remove();
        }

        window[cb] = (data) => {
          cleanup();
          resolve(data);
        };

        const sep = url.includes('?') ? '&' : '?';
        script.src = `${url}${sep}callback=${encodeURIComponent(cb)}`;
        script.onerror = () => {
          cleanup();
          reject(new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚.'));
        };

        document.body.appendChild(script);
      });
    }

    // âœ… NEW: totals + increment helpers (Apps Script)
    async function fetchTotalDownloads(){
      const el = document.getElementById('totalDownloads');
      if (el) el.textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: ...';

      if (!VALIDATION_WEBAPP_URL) return;

      try{
        const res = await jsonp(`${VALIDATION_WEBAPP_URL}?action=totals`, 8000);
        if (res && res.ok === true) {
          const total = (typeof res.total === 'number') ? res.total : (parseInt(String(res.total || '0'), 10) || 0);
          if (el) el.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: ${total}`;
        } else {
          if (el) el.textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: -';
        }
      }catch(e){
        console.warn('fetchTotalDownloads failed:', e);
        if (el) el.textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: -';
      }
    }

    async function incrementDownloadCount(studentId, last4){
      if (!VALIDATION_WEBAPP_URL) return;

      try{
        const url = `${VALIDATION_WEBAPP_URL}?action=inc&studentId=${encodeURIComponent(studentId)}&last4=${encodeURIComponent(last4)}`;
        const res = await jsonp(url, 8000);
        if (res && res.ok === true) {
          const totalEl = document.getElementById('totalDownloads');
          if (totalEl) {
            const total = (typeof res.total === 'number') ? res.total : (parseInt(String(res.total || '0'), 10) || 0);
            totalEl.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: ${total}`;
          }
        }
      }catch(e){
        console.warn('incrementDownloadCount failed:', e);
      }
    }
  </script>
</head>

<body>
  <div id="newsBanner" class="news-banner"><p></p></div>

  <div class="emoji-background" id="emojiContainer"></div>

  <div class="wrap">
    <section class="hero">
      <div class="hero-top">
        <div class="brand">
          <div class="brand-badge">
            <img src="https://i.postimg.cc/jSwbLwry/Asset-18.jpg" alt="">
          </div>
          <div>
            <p class="brand-title">Ù…Ù†ØµØ© Ø§Ù„Ø§Ø±Ø´Ø§Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ</p>
            <p class="brand-sub">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ØªØ¯Ø±Ø¨-Ø®Ø§Øµ Ø¨Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø§Ø¹Ù…Ø§Ù„ ÙƒÙ„ÙŠØ© Ø­Ø§ÙŠÙ„ Ø¨Ù†ÙŠÙ†</p>
          </div>
        </div>

        <div class="hero-meta">
          <div class="pill">ğŸ•’ <small id="timestamp"></small></div>
          <!-- âœ… NEW -->
          <div class="pill">ğŸ“¥ <small id="totalDownloads">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: ...</small></div>
          <div class="pill">ğŸ“ <small id="gpsPillText">...</small></div>
        </div>
      </div>

      <div class="note">
        Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ + Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„ØªØ­Ù‚Ù‚ØŒ Ø«Ù… Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ.
      </div>
    </section>

    <section class="card">
      <h1>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚</h1>
      <p class="helper">
        Ù…Ù„Ø§Ø­Ø¸Ø©:.
      </p>

      <form id="reportForm" novalidate>
        <div class="grid">
          <div class="field">
            <label for="studentId">
              Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨
              <span>9 Ø£Ø±Ù‚Ø§Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 4</span>
            </label>
            <div class="input-wrap">
              <input type="text" id="studentId" name="studentId" required
                pattern="4\d{8}" inputmode="numeric"
                placeholder="Ù…Ø«Ø§Ù„: 4xxxxxxxx" autocomplete="off">
              <button class="clear-btn" type="button" id="clearBtn1" aria-label="Ù…Ø³Ø­">âœ•</button>
            </div>
            <div class="field-error" id="fieldError1"></div>
          </div>

          <div class="field">
            <label for="last4">
              Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„
              <span>4 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</span>
            </label>
            <div class="input-wrap">
              <input type="text" id="last4" name="last4" required
                pattern="\d{4}" inputmode="numeric"
                placeholder="Ù…Ø«Ø§Ù„: 1234" autocomplete="off">
              <button class="clear-btn" type="button" id="clearBtn2" aria-label="Ù…Ø³Ø­">âœ•</button>
            </div>
            <div class="field-error" id="fieldError2"></div>
          </div>
        </div>

        <div class="cta">
          <button class="btn" type="submit" id="submitBtn">
            <span class="btn-loader" id="btnLoader">
              <img src="https://i.postimg.cc/jSwbLwry/Asset-18.jpg" alt="">
            </span>
            <span class="btn-text" id="btnText">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¢Ù†</span>
          </button>
        </div>
      </form>

      <div id="formDisabledMessage">
        Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªÙˆÙ‚ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ØµÙŠØ§Ù†Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚.
      </div>

      <div class="response" id="responseContainer">
        <div class="status" id="statusMessage"></div>
        <div class="result" id="resultContainer"></div>
      </div>
    </section>
  </div>

  <footer class="footer">
    <div class="inner">
      <span>2026</span>
      <span style="font-weight:950;color:rgba(15,23,42,.55)">Digital Guidance</span>
    </div>
  </footer>

  <script>
    // ===== Elements =====
    const form = document.getElementById('reportForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnLoader = document.getElementById('btnLoader');
    const btnText = document.getElementById('btnText');

    const responseContainer = document.getElementById('responseContainer');
    const statusMessage = document.getElementById('statusMessage');
    const resultContainer = document.getElementById('resultContainer');

    const fieldError1 = document.getElementById('fieldError1');
    const fieldError2 = document.getElementById('fieldError2');

    const clearBtn1 = document.getElementById('clearBtn1');
    const clearBtn2 = document.getElementById('clearBtn2');

    // Keep last submit for increment
    window.__lastSubmit = null;

    // ===== Floating background =====
    const emojiContainer = document.getElementById('emojiContainer');
    const emojis = ['ğŸ“š', 'ğŸ“', 'ğŸ“', 'ğŸ“–', 'âœï¸', 'ğŸ«'];
    const customLogoUrl = "https://i.postimg.cc/jSwbLwry/Asset-18.jpg"; // âœ… Ù†ÙØ³ ØµÙˆØ±Ø© Ø§Ù„Ù„ÙˆÙ‚Ùˆ

    function createFloatingItem() {
      const floatingItem = document.createElement('div');
      floatingItem.className = 'emoji-scroll';
      floatingItem.style.left = `${Math.random() * 100}%`;
      floatingItem.style.animationDuration = `${10 + Math.random() * 20}s`;

      if (Math.random() < 0.3) {
        const img = document.createElement('img');
        img.src = customLogoUrl;
        img.alt = " ";
        img.style.height = "30px";
        img.style.width = "auto";
        floatingItem.appendChild(img);
      } else {
        floatingItem.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      }
      emojiContainer.appendChild(floatingItem);
    }

    function startEmojiAnimation() {
      emojiContainer.innerHTML = '';
      for (let i = 0; i < 20; i++) {
        setTimeout(createFloatingItem, i * 500);
      }
    }

    // ===== Timestamp =====
    function updateTimestamp() {
      const options = { hour: 'numeric', minute: '2-digit', hour12: true };
      document.getElementById('timestamp').textContent = new Date().toLocaleTimeString('ar-EG', options);
    }
    setInterval(updateTimestamp, 1000);
    updateTimestamp();

    // ===== Field helpers =====
    function showFieldError(el, msg){
      el.textContent = msg;
      el.style.display = 'block';
    }
    function hideFieldError(el){
      el.textContent = '';
      el.style.display = 'none';
    }

    clearBtn1.addEventListener('click', () => {
      document.getElementById('studentId').value = '';
      hideFieldError(fieldError1);
    });
    clearBtn2.addEventListener('click', () => {
      document.getElementById('last4').value = '';
      hideFieldError(fieldError2);
    });

    document.getElementById('studentId').addEventListener('input', (e) => {
      const v = normalizeDigits(e.target.value).replace(/\D+/g,'').slice(0,9);
      if (v !== e.target.value) e.target.value = v;
      hideFieldError(fieldError1);
    });

    document.getElementById('last4').addEventListener('input', (e) => {
      const v = normalizeDigits(e.target.value).replace(/\D+/g,'').slice(0,4);
      if (v !== e.target.value) e.target.value = v;
      hideFieldError(fieldError2);
    });

    function setButtonLoading(isLoading){
      submitBtn.disabled = isLoading;
      btnLoader.style.display = isLoading ? 'inline-block' : 'none';
      btnText.textContent = isLoading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¢Ù†';
    }

    // ===== Status / Result =====
    function updateStatus(message, type = 'warning'){
      statusMessage.className = `status ${type}`;
      statusMessage.innerHTML = message;
    }

    function showError(message){
      console.error(message);
      responseContainer.style.display = 'block';
      updateStatus(message, 'error');
      resultContainer.innerHTML = '';
    }

    function resetUI(){
      resultContainer.innerHTML = '';
      statusMessage.className = 'status';
      statusMessage.innerHTML = '';
    }

    function showReportLink(url){
      resultContainer.innerHTML = `
        <div class="box">
          <div style="font-weight:950;font-size:1.05rem;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>
          <a href="${encodeURI(url)}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF ğŸ“„â¬‡ï¸</a>
          <div class="qr">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURI(url)}" alt="QR Code" />
          </div>
        </div>
      `;
      updateStatus('Ø¬Ø§Ù‡Ø²', 'success');
    }

    // ===== Validation via Apps Script WebApp =====
    async function validateStudent(studentIdRaw, last4Raw){
      const studentId = normalizeDigits(studentIdRaw).replace(/\D+/g,'');
      const last4 = normalizeDigits(last4Raw).replace(/\D+/g,'');

      if (!/^4\d{8}$/.test(studentId)) {
        throw new Error('Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù… 4');
      }
      if (!/^\d{4}$/.test(last4)) {
        throw new Error('Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨Ø© (4 Ø£Ø±Ù‚Ø§Ù…).');
      }
      if (!VALIDATION_WEBAPP_URL || VALIDATION_WEBAPP_URL.includes('PUT_YOUR')) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ (Apps Script Web App).');
      }

      const url = `${VALIDATION_WEBAPP_URL}?studentId=${encodeURIComponent(studentId)}&last4=${encodeURIComponent(last4)}`;
      const res = await jsonp(url);

      if (!res || res.ok !== true) {
        throw new Error(res?.msg || 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
      }
      return true;
    }

    // ===== GPS (ÙƒÙ…Ø§ Ù‡Ùˆ) =====
    function processLocationCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const locations = [];
      for (let i = 0; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (cols.length < 4) continue;
        const lat = parseFloat(cols[0]?.trim());
        const lon = parseFloat(cols[1]?.trim());
        const address = cols[3]?.trim() || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        if (!isNaN(lat) && !isNaN(lon)) {
          locations.push({ lat, lon, address });
        }
      }
      return locations;
    }

    function deg2rad(deg) { return deg * (Math.PI / 180); }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNearestLocation(userLat, userLon) {
      if (!locationData || locationData.length === 0) return null;
      let nearest = null;
      let minDistance = Number.MAX_VALUE;
      for (const loc of locationData) {
        const distance = getDistanceFromLatLonInKm(userLat, userLon, loc.lat, loc.lon);
        if (distance < minDistance) {
          minDistance = distance;
          nearest = { ...loc, distance };
        }
      }
      return minDistance <= RADIUS_KM ? nearest : null;
    }

    function performGpsCheck() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new Error('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.'));
        }
        if (!locationData) {
          return reject(new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚.'));
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const validLocation = findNearestLocation(userLat, userLon);

            if (validLocation) resolve(validLocation);
            else reject(new Error('Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ.'));
          },
          (error) => {
            console.error('Geolocation error:', error);
            reject(new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'));
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    // ===== Steps UI (keep gear spin) =====
    function updateStepsUI(steps, activeStep) {
      let html = `
        <div style="font-weight:950;margin-bottom:8px;">Ø­Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ</div>
        <div style="display:grid;gap:8px;">
      `;

      for (let i = 0; i < steps.length; i++) {
        const done = i < activeStep;
        const active = i === activeStep;

        html += `
          <div style="
            padding:10px 12px;
            border-radius: 16px;
            border:1px solid rgba(15,23,42,.10);
            background:${done ? 'rgba(22,163,74,.10)' : active ? 'rgba(245,158,11,.12)' : 'rgba(255,255,255,.75)'};
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap:10px;">
            <span>${steps[i]}</span>
            <span style="font-weight:950">
              ${done ? 'âœ…' : active ? '<span class="scrolling-gear">âš™ï¸</span>' : 'â³'}
            </span>
          </div>
        `;
      }
      html += `</div>`;
      updateStatus(html, 'warning');
    }

    function startProgressSteps(steps, updateCallback) {
      let currentStep = 0;
      let stopped = false;
      let timer;

      function nextStep() {
        if (stopped) return;
        if (currentStep < steps.length - 1) {
          currentStep++;
          updateCallback(steps, currentStep);
          const delay = Math.floor(Math.random() * (4000 - 2000 + 1)) + 2000;
          timer = setTimeout(nextStep, delay);
        } else {
          updateCallback(steps, currentStep);
          timer = setTimeout(nextStep, 3000);
        }
      }

      updateCallback(steps, currentStep);
      const initialDelay = Math.floor(Math.random() * (3500 - 2000 + 1)) + 2000;
      timer = setTimeout(nextStep, initialDelay);

      return {
        stop: () => { stopped = true; clearTimeout(timer); },
        complete: () => { stopped = true; currentStep = steps.length; updateCallback(steps, currentStep); }
      };
    }

    // ===== Poll with backoff =====
    async function pollReportStatus(statusUrl) {
      const steps = [
        "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        "Ø¬Ø§Ø±ÙŠ Ø±Ø³Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø¬Ø±ÙŠØ©",
        "Ø¬Ø§Ø±ÙŠ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©",
        "Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ø§Ù…Ù„"
      ];
      const progress = startProgressSteps(steps, updateStepsUI);

      let delay = POLL_BASE;

      try {
        while (true) {
          const response = await fetch(statusUrl);
          const data = await response.json();

          if (data.status === 'Succeeded') {
            const finalUrl = data?.output?.reportUrl || data?.properties?.outputs?.reportUrl;
            if (finalUrl) {
              progress.complete();
              showReportLink(finalUrl);

              // âœ… NEW: increment count after success
              if (window.__lastSubmit?.studentId && window.__lastSubmit?.last4) {
                incrementDownloadCount(window.__lastSubmit.studentId, window.__lastSubmit.last4);
              }

              return;
            }
            throw new Error('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©');
          }

          if (data.reportUrl) {
            progress.complete();
            showReportLink(data.reportUrl);

            // âœ… NEW: increment count after success
            if (window.__lastSubmit?.studentId && window.__lastSubmit?.last4) {
              incrementDownloadCount(window.__lastSubmit.studentId, window.__lastSubmit.last4);
            }

            return;
          }

          if (data.status === 'Failed') {
            progress.stop();
            throw new Error(data.error?.message || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ');
          }

          await new Promise(resolve => setTimeout(resolve, delay));
          delay = Math.min(POLL_MAX, Math.floor(delay * 1.35));
        }
      } catch (error) {
        progress.stop();
        showError(error.message);
      }
    }

    // ===== Submit =====
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitBtn.disabled) return;

      const studentId = document.getElementById('studentId').value.trim();
      const last4 = document.getElementById('last4').value.trim();

      const cleanedId = normalizeDigits(studentId).replace(/\D+/g,'');
      const cleaned4 = normalizeDigits(last4).replace(/\D+/g,'').slice(0,4);

      hideFieldError(fieldError1);
      hideFieldError(fieldError2);

      if (!cleanedId) return showFieldError(fieldError1, 'ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨');
      if (!/^4\d{8}$/.test(cleanedId)) return showFieldError(fieldError1, 'Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 9 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù… 4');

      if (!cleaned4) return showFieldError(fieldError2, 'ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„');
      if (!/^\d{4}$/.test(cleaned4)) return showFieldError(fieldError2, 'Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');

      // âœ… keep last submit for increment later
      window.__lastSubmit = { studentId: cleanedId, last4: cleaned4 };

      setButtonLoading(true);
      startEmojiAnimation();
      resetUI();
      responseContainer.style.display = 'block';

      try {
        updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„...', 'warning');
        await validateStudent(cleanedId, cleaned4);

        // âœ… GPS flag
        if (ENABLE_GPS_VERIFY) {
          updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ.', 'warning');
          await performGpsCheck();
          updateStatus('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
        } else {
          updateStatus('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS ØºÙŠØ± Ù…ÙØ¹Ù„).', 'warning');
        }

        const response = await fetch(FLOW_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId: cleanedId })
        });

        if (response.status === 202) {
          let statusUrl = response.headers.get('Location');
          if (!statusUrl) {
            const body = await response.json();
            statusUrl = body.statusQueryGetUri || body.properties?.statusQueryGetUri;
          }
          if (!statusUrl) throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
          await pollReportStatus(statusUrl);
        } else if (response.ok) {
          const data = await response.json();
          if (data.reportUrl) {
            showReportLink(data.reportUrl);

            // âœ… NEW: increment count after success
            if (window.__lastSubmit?.studentId && window.__lastSubmit?.last4) {
              incrementDownloadCount(window.__lastSubmit.studentId, window.__lastSubmit.last4);
            }
          } else {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ø®Øµ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
          }
        } else {
          throw new Error(`Ø®Ø·Ø£ HTTP! Ø§Ù„Ø­Ø§Ù„Ø©: ${response.status}`);
        }

      } catch (err) {
        showError(err.message);
      } finally {
        setButtonLoading(false);
      }
    });
  </script>
</body>
</html>



